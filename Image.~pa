unit Image;

interface
uses
  Windows, Messages, SysUtils, Classes, Graphics, Controls, Forms, Dialogs,
  StdCtrls, ExtCtrls, Menus, QCCom32,ausgabe;

procedure image_loeschen;
procedure image_loeschen_2;
procedure zeichnen;
procedure neuzeichnen;
Procedure redraw;
procedure last_pic_malen;

implementation
uses lasersoftware;

// Nur Zeichenfläche löschen
procedure image_loeschen_2;
begin
form1.i1.canvas.Brush.color:=clbtnface;
form1.i1.Canvas.FillRect(rect(0,0,258,258));
end;

// Zeichenfläche löschen und Gitter zeichnen
procedure Image_loeschen;
begin
 form1.i1.canvas.Brush.color:=clbtnface;
 form1.i1.Canvas.FillRect(rect(0,0,258,258));
 form1.i1.canvas.pen.color:=10003608;
 form1.i1.canvas.pen.Width:=1;
 form1.i1.Canvas.MoveTo(0,0);form1.i1.canvas.LineTo(256,0);
 form1.i1.Canvas.MoveTo(0,32);form1.i1.canvas.LineTo(256,32);
 form1.i1.Canvas.MoveTo(0,64);form1.i1.canvas.LineTo(256,64);
 form1.i1.Canvas.MoveTo(0,96);form1.i1.canvas.LineTo(256,96);
 form1.i1.Canvas.MoveTo(0,128);form1.i1.canvas.LineTo(256,128);
 form1.i1.Canvas.MoveTo(0,160);form1.i1.canvas.LineTo(256,160);
 form1.i1.Canvas.MoveTo(0,192);form1.i1.canvas.LineTo(256,192);
 form1.i1.Canvas.MoveTo(0,224);form1.i1.canvas.LineTo(256,224);
 form1.i1.Canvas.MoveTo(0,256);form1.i1.canvas.LineTo(256,256);

 form1.i1.Canvas.MoveTo(0,0);form1.i1.canvas.LineTo(0,256);
 form1.i1.Canvas.MoveTo(32,0);form1.i1.canvas.LineTo(32,256);
 form1.i1.Canvas.MoveTo(64,0);form1.i1.canvas.LineTo(64,256);
 form1.i1.Canvas.MoveTo(96,0);form1.i1.canvas.LineTo(96,256);
 form1.i1.Canvas.MoveTo(128,0);form1.i1.canvas.LineTo(128,256);
 form1.i1.Canvas.MoveTo(160,0);form1.i1.canvas.LineTo(160,256);
 form1.i1.Canvas.MoveTo(192,0);form1.i1.canvas.LineTo(192,256);
 form1.i1.Canvas.MoveTo(224,0);form1.i1.canvas.LineTo(224,256);
 form1.i1.Canvas.MoveTo(256,0);form1.i1.canvas.LineTo(256,256);

 form1.i1.canvas.pen.color:=clred;
 form1.i1.canvas.pen.Width:=2;
end;

// Zeichnen nach Mausklick
procedure zeichnen;
var Bild,points:integer;
begin
if form1.rb1.checked=true then form1.i1.canvas.pen.color:=clwhite;
if form1.rb2.checked=true then form1.i1.canvas.pen.color:=clred;
if form1.rb3.checked=true then form1.i1.canvas.pen.color:=64592;
if form1.rb4.checked=true then form1.i1.canvas.pen.color:=clblue;
bild:=form1.sb1.position;
// erster Punkt ? ?
   if punkte=0 then
     begin
       port:=2;
       form1.i1.canvas.moveto(xneu,yneu);
       xalt:=xneu;yalt:=yneu;
       if copy(form1.lb1.items[form1.sb1.position+20],1,1)<>'' then
       port:=1;
       if xneu>255 then xneu:=255;if yneu>255 then yneu:=255;
       // LB
       form1.lb1.items[form1.sb1.position+20]:=
       form1.lb1.items[form1.sb1.position+20]+
       inttohex(port,2)+inttohex(xneu,2)+inttohex(yneu,2);
       punkte:=punkte+3;

     end
// oder doch nicht ?
   else
      begin
        form1.Button3.enabled:=true; //UNDO
        form1.i1.Canvas.LineTo(xneu,yneu);
        xalt:=xneu;yalt:=yneu;
        if form1.rb2.checked=true then port:=2;
        if form1.rb3.checked=true then port:=4;
        if form1.rb4.checked=true then port:=8;
        // LB
        if xneu>255 then xneu:=255;if yneu>255 then yneu:=255;
        form1.lb1.items[form1.sb1.position+20]:=
        form1.lb1.items[form1.sb1.position+20]+
        inttohex(port,2)+inttohex(xneu,2)+inttohex(yneu,2);
        punkte:=punkte+3;
      end;

end;

// Neuzeichnen
procedure neuzeichnen;
begin
 form1.sb2.position:=strtoint(form1.lb1.items[0]);
 form1.panel3.caption:=inttostr(form1.sb2.position);
 form1.sb3.position:=strtoint(form1.lb1.items[1]);
 form1.panel4.caption:=inttostr(form1.sb3.position);
 form1.sb1.position:=1;
 

end;

procedure redraw;
var p,x,y,a:integer;
begin
if (copy((form1.lb1.items[form1.sb1.position+20]),1,1)<>'') and
    (punkte=0)
    then
    begin
     port:=strtoint
     ('$'+copy(form1.lb1.items[form1.sb1.position+20],1,2));
     x:=strtoint
     ('$'+copy(form1.lb1.items[form1.sb1.position+20],3,2));
     y:=strtoint
     ('$'+copy(form1.lb1.items[form1.sb1.position+20],5,2));
     form1.i1.Canvas.MoveTo(x,y);
     punkte:=punkte+1;
    end;

if (copy((form1.lb1.items[form1.sb1.position+20]),7,1)<>'') then
 repeat
    port:=strtoint
     ('$'+copy(form1.lb1.items[form1.sb1.position+20],(punkte*6+1),2));
    if port=1 then form1.i1.canvas.pen.color:=clwhite;
    if port=2 then form1.i1.canvas.pen.color:=clred;
    if port=4 then form1.i1.canvas.pen.color:=64592;
    if port=8 then form1.i1.canvas.pen.color:=clblue;
    x:=strtoint
    ('$'+copy(form1.lb1.items[form1.sb1.position+20],(punkte*6+3),2));
    y:=strtoint
    ('$'+copy(form1.lb1.items[form1.sb1.position+20],(punkte*6+5),2));
        form1.i1.canvas.LineTo(x,y);
    punkte:=punkte+1;
    application.ProcessMessages;
  until copy(form1.lb1.items[form1.sb1.position+20],(punkte*6+6),1)='';

  if port=1 then form1.rb1.checked:=true;
  if port=2 then form1.rb2.checked:=true;
  if port=4 then form1.rb3.checked:=true;
  if port=8 then form1.rb4.checked:=true;
  if form1.cb34.checked=true then last_pic_malen;
  a:=length(form1.lb1.items[form1.sb1.position+20]);
  form1.panel29.caption:=inttostr(round(a/6));
end;

procedure last_pic_malen;
var altef,x,y:integer;b:String;
begin
punkte:=0;
// Alte Malfarbe sichern
altef:=form1.i1.canvas.pen.color;
form1.i1.canvas.pen.color:=clteal;
// Gibts ein vorheriges Bild ?
b:=copy(form1.lb1.items[form1.sb1.position+19],(punkte*6),2) ;
if (form1.sb1.position>1) and
   (copy(form1.lb1.items[form1.sb1.position+19],(punkte*6),1)<>'') then
  begin
    // MOVE zum ersten Punkt
    punkte:=0;
    x:=strtoint
    ('$'+copy(form1.lb1.items[form1.sb1.position+19],(punkte*6+3),2));
    y:=strtoint
    ('$'+copy(form1.lb1.items[form1.sb1.position+19],(punkte*6+5),2));
        form1.i1.canvas.moveTo(x,y);
    // Male den Rest
    repeat
    port:=strtoint
     ('$'+copy(form1.lb1.items[form1.sb1.position+19],(punkte*6+1),2));
    if port=1 then form1.i1.canvas.pen.color:=clwhite else
                   form1.i1.canvas.pen.color:=clteal;
    x:=strtoint
    ('$'+copy(form1.lb1.items[form1.sb1.position+19],(punkte*6+3),2));
    y:=strtoint
    ('$'+copy(form1.lb1.items[form1.sb1.position+19],(punkte*6+5),2));
        form1.i1.canvas.LineTo(x,y);
    punkte:=punkte+1;
    application.ProcessMessages;
  until copy(form1.lb1.items[form1.sb1.position+19],(punkte*6+6),1)='';
end; // Ende Malrouteine
punkte:=round(length(form1.lb1.items[form1.sb1.position+20])/6);

end;



end.
